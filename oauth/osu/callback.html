<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>osu! OAuth - Linking Account</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 20px;
				color: #fff;
			}

			.container {
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px);
				border-radius: 20px;
				padding: 40px;
				max-width: 600px;
				width: 100%;
				box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
				border: 1px solid rgba(255, 255, 255, 0.18);
			}

			.logo {
				text-align: center;
				margin-bottom: 30px;
			}

			.logo h1 {
				font-size: 2.5em;
				font-weight: 700;
				margin-bottom: 10px;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
			}

			.logo p {
				font-size: 1.1em;
				opacity: 0.9;
			}

			.status {
				background: rgba(255, 255, 255, 0.15);
				border-radius: 15px;
				padding: 30px;
				text-align: center;
				position: relative;
				overflow: hidden;
			}

			.spinner {
				width: 60px;
				height: 60px;
				margin: 0 auto 20px;
				border: 4px solid rgba(255, 255, 255, 0.3);
				border-top: 4px solid #fff;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			.status-text {
				font-size: 1.2em;
				margin-bottom: 15px;
				font-weight: 500;
			}

			.details {
				background: rgba(0, 0, 0, 0.2);
				border-radius: 10px;
				padding: 20px;
				margin-top: 20px;
				text-align: left;
				font-family: 'Courier New', monospace;
				font-size: 0.9em;
				max-height: 300px;
				overflow-y: auto;
				white-space: pre-wrap;
				word-wrap: break-word;
				line-height: 1.6;
			}

			.details::-webkit-scrollbar {
				width: 8px;
			}

			.details::-webkit-scrollbar-track {
				background: rgba(255, 255, 255, 0.1);
				border-radius: 10px;
			}

			.details::-webkit-scrollbar-thumb {
				background: rgba(255, 255, 255, 0.3);
				border-radius: 10px;
			}

			.success {
				background: rgba(76, 175, 80, 0.2);
			}

			.error {
				background: rgba(244, 67, 54, 0.2);
			}

			.checkmark {
				width: 60px;
				height: 60px;
				margin: 0 auto 20px;
				border-radius: 50%;
				display: block;
				stroke-width: 3;
				stroke: #fff;
				stroke-miterlimit: 10;
				box-shadow: inset 0px 0px 0px #4caf50;
				animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
			}

			.checkmark-circle {
				stroke-dasharray: 166;
				stroke-dashoffset: 166;
				stroke-width: 3;
				stroke-miterlimit: 10;
				stroke: #4caf50;
				fill: none;
				animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
			}

			.checkmark-check {
				transform-origin: 50% 50%;
				stroke-dasharray: 48;
				stroke-dashoffset: 48;
				animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
			}

			@keyframes stroke {
				100% { stroke-dashoffset: 0; }
			}

			@keyframes scale {
				0%, 100% { transform: none; }
				50% { transform: scale3d(1.1, 1.1, 1); }
			}

			@keyframes fill {
				100% { box-shadow: inset 0px 0px 0px 30px #4caf50; }
			}

			.error-icon {
				width: 60px;
				height: 60px;
				margin: 0 auto 20px;
				border-radius: 50%;
				background: #f44336;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 2em;
				animation: scale 0.3s ease-in-out;
			}

			.hidden {
				display: none;
			}

			.input-form {
				background: rgba(255, 255, 255, 0.15);
				border-radius: 15px;
				padding: 30px;
				text-align: center;
			}

			.input-form h2 {
				font-size: 1.5em;
				margin-bottom: 10px;
				font-weight: 600;
			}

			.input-form p {
				font-size: 0.95em;
				opacity: 0.9;
				margin-bottom: 25px;
				line-height: 1.5;
			}

			.input-group {
				margin-bottom: 20px;
			}

			.input-group input {
				width: 100%;
				padding: 15px 20px;
				font-size: 1em;
				border: 2px solid rgba(255, 255, 255, 0.3);
				border-radius: 10px;
				background: rgba(255, 255, 255, 0.2);
				color: #fff;
				outline: none;
				transition: all 0.3s ease;
				font-family: inherit;
			}

			.input-group input::placeholder {
				color: rgba(255, 255, 255, 0.6);
			}

			.input-group input:focus {
				border-color: rgba(255, 255, 255, 0.6);
				background: rgba(255, 255, 255, 0.25);
			}

			.btn {
				width: 100%;
				padding: 15px 30px;
				font-size: 1.1em;
				font-weight: 600;
				border: none;
				border-radius: 10px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: #fff;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.4);
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.6);
			}

			.btn:active {
				transform: translateY(0);
			}

			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none;
			}

			.help-text {
				font-size: 0.85em;
				opacity: 0.8;
				margin-top: 15px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="logo">
				<img src="https://i.ppy.sh/013ed2c11b34720790e74035d9f49078d5e9aa64/68747470733a2f2f6f73752e7070792e73682f77696b692f696d616765732f4272616e645f6964656e746974795f67756964656c696e65732f696d672f75736167652d66756c6c2d636f6c6f75722e706e67"></img>
				<p>Account Linking</p>
			</div>
			
			<div class="input-form" id="inputForm">
				<h2>Enter your Discord Username</h2>
				<p>Please enter your Discord username so we can link your osu! account. This will check the osu!lounge server for any members with the same username.</p>
				<div class="input-group">
					<input type="text" id="discordUsername" placeholder="username" autocomplete="off" />
				</div>
				<button class="btn" id="submitBtn" onclick="searchDiscordUser()">Continue</button>
				<p class="help-text">Example: br0k3x, ifyouwanna, etc..</p>
			</div>
			
			<div class="status hidden" id="status">
				<div class="spinner" id="spinner"></div>
				<div class="status-text" id="statusText">Processing OAuth callback</div>
				<div class="details" id="details"></div>
			</div>
		</div>
		<script>
			let discordUserId = null;
			
			async function searchDiscordUser() {
				const inputForm = document.getElementById('inputForm');
				const statusEl = document.getElementById('status');
				const spinnerEl = document.getElementById('spinner');
				const statusText = document.getElementById('statusText');
				const details = document.getElementById('details');
				const usernameInput = document.getElementById('discordUsername');
				const submitBtn = document.getElementById('submitBtn');
				
				const username = usernameInput.value.trim();
				
				if (!username) {
					alert('Please enter your Discord username');
					return;
				}
				
				submitBtn.disabled = true;
				submitBtn.textContent = 'Searching...';
				
				try {
					const response = await fetch('https://stats.br0k3x.info/api/discord/search-user', {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ username })
					});
					
					if (!response.ok) {
						const errorData = await response.json();
						alert(errorData.error || 'User not found in the server');
						submitBtn.disabled = false;
						submitBtn.textContent = 'Continue';
						return;
					}
					
					const data = await response.json();
					discordUserId = data.userId;
					
					// Hide form, show processing
					inputForm.classList.add('hidden');
					statusEl.classList.remove('hidden');
					
					// Start OAuth process
					processOAuth();
					
				} catch (error) {
					alert('Error searching for Discord user: ' + error.message);
					submitBtn.disabled = false;
					submitBtn.textContent = 'Continue';
				}
			}
			
			async function processOAuth() {
				const statusEl = document.getElementById('status');
				const spinnerEl = document.getElementById('spinner');
				const statusText = document.getElementById('statusText');
				const details = document.getElementById('details');
				
				function showSuccess(message) {
					spinnerEl.classList.add('hidden');
					statusEl.classList.add('success');
					statusText.innerHTML = message;
					
					const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
					svg.classList.add('checkmark');
					svg.setAttribute('viewBox', '0 0 52 52');
					svg.innerHTML = '<circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>';
					statusEl.insertBefore(svg, statusText);
				}
				
				function showError(message) {
					spinnerEl.classList.add('hidden');
					statusEl.classList.add('error');
					statusText.innerHTML = message;
					
					const errorIcon = document.createElement('div');
					errorIcon.classList.add('error-icon');
					errorIcon.innerHTML = 'âœ•';
					statusEl.insertBefore(errorIcon, statusText);
				}
				
				function addDetails(text) {
					details.textContent += text + '\n';
				}
				
				// Debug: Log full URL
				addDetails('Debug - Full URL: ' + window.location.href);
				addDetails('Debug - Search: ' + window.location.search);
				addDetails('Debug - Hash: ' + window.location.hash);
				
				// Try query string first, then hash fragment (for implicit flow)
				let params = new URLSearchParams(window.location.search);
				if (!params.has('code') && window.location.hash) {
					params = new URLSearchParams(window.location.hash.substring(1));
				}
				
				const code = params.get('code');
				const state = params.get('state');
				const error = params.get('error');
				const error_description = params.get('error_description');
				
				// Handle OAuth error response
				if (error) {
					showError('OAuth Authorization Failed');
					addDetails('Error: ' + error);
					if (error_description) {
						addDetails('Description: ' + error_description);
					}
					return;
				}
				
				if (!code) {
					showError('Missing OAuth Parameters');
					addDetails('Missing authorization code in query.\n\nPossible causes:');
					addDetails('â€¢ The OAuth redirect URL doesn\'t match what is registered with osu!');
					addDetails('â€¢ You accessed this page directly instead of through OAuth');
					addDetails('â€¢ The OAuth flow was not initiated correctly');
					addDetails('\nCurrent URL: ' + window.location.href);
					return;
				}
				
				statusText.textContent = 'Exchanging authorization code with osu.ppy.sh...';
				
				try {
					const res = await fetch('https://stats.br0k3x.info/api/oauth/osu/callback', {
						method: 'POST', 
						headers: {'Content-Type':'application/json'},
						body: JSON.stringify({code, state: discordUserId})
					});
					
					if (!res.ok) {
						const text = await res.text();
						showError('API Error');
						addDetails('Status: ' + res.status + ' ' + res.statusText);
						addDetails('Response: ' + text);
						return;
					}
					
					const j = await res.json();
					statusText.textContent = 'Storing Discord UserID in db for linking...';
					addDetails('âœ“ OAuth2 tokens received from osu!v2');

					const disclink = await fetch('https://stats.br0k3x.info/api/oauth/osu/link/discord', {
						method: 'POST', 
						headers: {'Content-Type':'application/json'},
						body: JSON.stringify({'id': discordUserId, 'osu_token': j.tokens.access_token, 'osu_refresh': j.tokens.refresh_token})
					});
					
					if (!disclink.ok) {
						const linkErr = await disclink.text();
						showError('Discord Linking Failed');
						addDetails('Status: ' + disclink.status + ' ' + disclink.statusText);
						addDetails('Response: ' + linkErr);
						return;
					}
					
					showSuccess('Account Linked Successfully! ðŸŽ‰');
					addDetails('âœ“ Discord API connected');
					addDetails('âœ“ Discord account linked');
					addDetails('âœ“ Verified role assigned');
					addDetails('\nYou now have full access to osu!lounge features.');
					addDetails('You may close this tab.');
					
				} catch (e) {
					showError('Connection Error');
					addDetails('Failed to connect to API: ' + e.message);
					addDetails('\nPlease check your internet connection and try again.');
				}
			}
		</script>
	</body>
</html>
